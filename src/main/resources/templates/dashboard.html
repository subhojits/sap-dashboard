<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAP Integration Event Dashboard</title>
    <!-- Link CSS file -->
    <link rel="stylesheet" th:href="@{/css/style.css}" />
    <!-- Chart.js library for charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Payload Editor Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal.show {
            display: block;
        }

        .modal-content {
            background-color: var(--color-surface);
            margin: 5% auto;
            padding: 20px;
            border: 1px solid var(--color-border);
            border-radius: 8px;
            width: 90%;
            max-width: 900px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--color-border);
            padding-bottom: 10px;
        }

        .modal-header h2 {
            margin: 0;
            color: var(--color-text);
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: var(--color-text);
        }

        .close-btn:hover {
            color: var(--color-error);
        }

        .payload-editor {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .editor-info {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .info-item {
            padding: 10px;
            background-color: var(--color-secondary);
            border-radius: 4px;
        }

        .info-label {
            font-weight: 600;
            font-size: 12px;
            color: var(--color-text-secondary);
            text-transform: uppercase;
        }

        .info-value {
            color: var(--color-text);
            margin-top: 5px;
            word-break: break-all;
        }

        .textarea-wrapper {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .textarea-label {
            font-weight: 600;
            color: var(--color-text);
        }

        #payloadEditor {
            font-family: 'Courier New', monospace;
            font-size: 13px;
            padding: 12px;
            border: 1px solid var(--color-border);
            border-radius: 4px;
            background-color: var(--color-background);
            color: var(--color-text);
            min-height: 300px;
            max-height: 400px;
            overflow-y: auto;
            line-height: 1.4;
            resize: vertical;
        }

        #userNotes {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 14px;
            padding: 10px;
            border: 1px solid var(--color-border);
            border-radius: 4px;
            background-color: var(--color-background);
            color: var(--color-text);
            min-height: 80px;
            resize: vertical;
        }

        .syntax-hint {
            font-size: 12px;
            color: var(--color-text-secondary);
            padding: 10px;
            background-color: var(--color-secondary);
            border-radius: 4px;
            margin-top: 5px;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--color-border);
        }

        .modal-actions button {
            padding: 10px 20px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        .btn-submit {
            background-color: var(--color-primary);
            color: var(--color-btn-primary-text);
        }

        .btn-submit:hover {
            background-color: var(--color-primary-hover);
        }

        .btn-submit:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-cancel {
            background-color: var(--color-secondary);
            color: var(--color-text);
        }

        .btn-cancel:hover {
            background-color: var(--color-secondary-hover);
        }

        .retry-info {
            background-color: var(--color-bg-4);
            border-left: 4px solid var(--color-warning);
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 15px;
        }

        .retry-info-text {
            color: var(--color-text);
            font-size: 14px;
        }

        .payload-format-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            background-color: var(--color-primary);
            color: var(--color-btn-primary-text);
        }
        /* üõë FIX: Modal Visibility & Positioning */

/* Modal backdrop - ensures modal is on top */
.modal-backdrop {
    position: fixed;
    top: 0;
    left: 0;
    z-index: 1040;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
}

/* Modal dialog - properly positioned */
.modal.show {
    display: flex !important;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 1050;
    width: 90%;
    max-width: 600px;
    background-color: white;
    border-radius: 8px;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
}

/* Modal content */
.modal-content {
    position: relative;
    display: flex;
    flex-direction: column;
    width: 100%;
    background-color: #fff;
    background-clip: padding-box;
    border: 1px solid rgba(0, 0, 0, 0.15);
    border-radius: 0.25rem;
}

/* Modal header */
.modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1rem;
    border-bottom: 1px solid #dee2e6;
    background-color: #f8f9fa;
}

/* Modal title */
.modal-title {
    margin-bottom: 0;
    line-height: 1.5;
    font-size: 1.25rem;
    font-weight: 500;
    color: #333;
}

/* Modal body - ensure scrollable */
.modal-body {
    position: relative;
    flex: 1 1 auto;
    padding: 1rem;
    overflow-y: auto;
    max-height: 70vh;
}

/* Modal footer */
.modal-footer {
    display: flex;
    align-items: center;
    justify-content: flex-end;
    padding: 1rem;
    border-top: 1px solid #dee2e6;
    background-color: #f8f9fa;
    gap: 0.5rem;
}

/* Close button */
.btn-close {
    cursor: pointer;
    padding: 0.25rem;
    background: transparent;
    border: 0;
    font-size: 1.5rem;
    color: #000;
    opacity: 0.5;
    transition: opacity 0.2s;
}

.btn-close:hover {
    opacity: 0.75;
}

/* Prevent body scrolling when modal open */
body.modal-open {
    overflow: hidden;
}

/* Fix for form elements in modal */
.modal input,
.modal textarea,
.modal select {
    width: 100%;
    padding: 0.5rem;
    margin-bottom: 1rem;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-family: inherit;
}

.modal input:focus,
.modal textarea:focus,
.modal select:focus {
    outline: none;
    border-color: #0066cc;
    box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.1);
}

/* Ensure editor/textarea is visible */
.modal textarea {
    min-height: 200px;
    resize: vertical;
}
/* üåô Dark Mode Support */

/* Light Mode (default) */
.modal {
    --modal-bg: #ffffff;
    --modal-text: #333333;
    --modal-border: #e0e0e0;
    --modal-header-bg: #f8f9fa;
    --input-bg: #ffffff;
    --input-text: #333333;
    --input-border: #dddddd;
}

/* Dark Mode */
@media (prefers-color-scheme: dark) {
    .modal {
        --modal-bg: #2d2d2d;
        --modal-text: #e8e8e8;
        --modal-border: #404040;
        --modal-header-bg: #1f1f1f;
        --input-bg: #3a3a3a;
        --input-text: #e8e8e8;
        --input-border: #505050;
    }
}

/* Apply Variables */
.modal-content {
    background-color: var(--modal-bg);
    color: var(--modal-text);
    border: 1px solid var(--modal-border);
}

.modal-header {
    background-color: var(--modal-header-bg);
    border-bottom-color: var(--modal-border);
    color: var(--modal-text);
}

.modal-body {
    background-color: var(--modal-bg);
    color: var(--modal-text);
}

.modal-footer {
    background-color: var(--modal-header-bg);
    border-top-color: var(--modal-border);
}

/* Form Elements */
.modal input,
.modal textarea,
.modal select {
    background-color: var(--input-bg);
    color: var(--input-text);
    border: 1px solid var(--input-border);
}

.modal input:focus,
.modal textarea:focus,
.modal select:focus {
    background-color: var(--input-bg);
    color: var(--input-text);
    border-color: #0066cc;
}

.modal label {
    color: var(--modal-text);
}
    </style>
</head>
<body>

<!-- ===== NAVIGATION BAR ===== -->
<nav class="navbar">
    <div class="navbar-content">
        <h1>üìä SAP Integration Event Dashboard</h1>
        <div class="navbar-actions">
            <!-- Button to toggle dark mode -->
            <button onclick="toggleDarkMode()" class="btn-icon">üåô</button>
            <!-- Current time -->
            <span class="time" id="currentTime"></span>
        </div>
    </div>
</nav>

<!-- ===== MAIN CONTAINER ===== -->
<div class="container">

    <!-- ===== STATISTICS CARDS ===== -->
    <!-- These show: Total Events, Success Rate, Failed, Pending -->
    <div class="stats-grid">

        <!-- Card 1: Total Events -->
        <div class="stat-card">
            <div class="stat-icon">üìà</div>
            <div class="stat-content">
                <h3>Total Events</h3>
                <!-- Get value from controller: stats.totalEvents -->
                <p class="stat-number" th:text="${stats.totalEvents}">0</p>
            </div>
        </div>

        <!-- Card 2: Success Rate -->
        <div class="stat-card success">
            <div class="stat-icon">‚úì</div>
            <div class="stat-content">
                <h3>Success Rate</h3>
                <!-- Add % sign to the success rate -->
                <p class="stat-number" th:text="${stats.successRate} + '%'">0%</p>
            </div>
        </div>

        <!-- Card 3: Failed -->
        <div class="stat-card warning">
            <div class="stat-icon">‚ö†Ô∏è</div>
            <div class="stat-content">
                <h3>Failed</h3>
                <p class="stat-number" th:text="${stats.failedCount}">0</p>
            </div>
        </div>

        <!-- Card 4: Pending -->
        <div class="stat-card pending">
            <div class="stat-icon">‚è≥</div>
            <div class="stat-content">
                <h3>Pending</h3>
                <p class="stat-number" th:text="${stats.pendingCount}">0</p>
            </div>
        </div>
    </div>

    <!-- ===== SEARCH AND FILTER SECTION ===== -->
    <div class="search-section">

        <!-- Search form -->
        <form method="post" th:action="@{/search}" class="search-form">
            <input type="text" name="orderId" placeholder="üîç Search by Order ID..." class="search-input" />
            <button type="submit" class="btn btn-primary">Search</button>
        </form>

        <!-- Filter dropdown -->
        <form method="post" th:action="@{/filter}" class="filter-form">
            <select name="status" class="filter-select" onchange="this.form.submit()">
                <option value="">All Status</option>
                <option value="SUCCESS">‚úì Success</option>
                <option value="FAILED">‚úó Failed</option>
                <option value="PENDING">‚è≥ Pending</option>
            </select>
        </form>

        <!-- Refresh button -->
        <form method="post" th:action="@{/}" class="refresh-form">
            <button type="button" onclick="location.reload()" class="btn btn-secondary">üîÑ Refresh</button>
        </form>
    </div>

    <!-- ===== EVENTS TABLE ===== -->
    <div class="table-section">
        <h2>üìã Recent Events</h2>
        <div class="table-wrapper">
            <table class="events-table">
                <thead>
                <tr>
                    <th>#</th>
                    <th>Order ID</th>
                    <th>Integration</th>
                    <th>Status</th>
                    <th>Message</th>
                    <th>Time</th>
                    <th>Action</th>
                </tr>
                </thead>
                <tbody>
                <!-- Loop through all events -->
                <!-- iterStat gives us: count (1,2,3...), index (0,1,2...), first, last -->
                <tr th:each="event, iterStat : ${events}"
                    th:class="${event.status == 'SUCCESS' ? 'row-success' : event.status == 'FAILED' ? 'row-failed' : 'row-pending'}">

                    <!-- Row number (1, 2, 3...) -->
                    <td th:text="${iterStat.count}">1</td>

                    <!-- Order ID -->
                    <td th:text="${event.orderId}">PO-12345</td>

                    <!-- Integration name -->
                    <td th:text="${event.integrationName}">Order-to-SAP</td>

                    <!-- Status badge (colored) -->
                    <td>
                                <span class="badge"
                                      th:class="${event.status == 'SUCCESS' ? 'badge-success' : event.status == 'FAILED' ? 'badge-danger' : 'badge-warning'}"
                                      th:text="${event.status}">SUCCESS</span>
                    </td>

                    <!-- Message -->
                    <td th:text="${event.message}">Order placed successfully</td>

                    <!-- Time (formatted as "2 mins ago") -->
                    <td th:text="${event.getTimeAgo()}">2 mins ago</td>

                    <!-- Action button (Retry for failed, View for others) -->
                    <td>
                        <!-- If status is FAILED, show Retry button -->
                        <button th:unless="${event.status != 'FAILED'}" class="btn btn--primary btn--sm" th:onclick="'openPayloadModal(' + ${event.id} + ')'">
                            üîÑ Edit & Retry
                        </button>

                        <!-- Otherwise show disabled View button -->
                        <button th:unless="${event.status == 'FAILED'}"
                                class="btn btn--sm btn--primary" disabled>üß≠ View</button>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- ===== CHART SECTION ===== -->
    <div class="chart-section">
        <h2>üìä Event Statistics</h2>
        <!-- Canvas for Chart.js -->
        <canvas id="statsChart"></canvas>
    </div>

</div>
<!-- Add this modal HTML before closing </body> tag -->
<div id="payloadModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>üìù Retry Failed Event - Edit Payload</h2>
            <button class="close-btn" onclick="closePayloadModal()">&times;</button>
        </div>

        <div class="payload-editor">
            <!-- Retry Information -->
            <div class="retry-info">
                <div class="retry-info-text">
                    ‚ö†Ô∏è <strong>Max 3 retry attempts allowed.</strong> Edit the payload below to fix the error and resubmit.
                </div>
            </div>

            <!-- Event Details -->
            <div class="editor-info">
                <div class="info-item">
                    <div class="info-label">Order ID</div>
                    <div class="info-value" id="modalOrderId">-</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Retry Attempt</div>
                    <div class="info-value" id="modalRetryCount">-</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Format</div>
                    <div class="info-value">
                        <span class="payload-format-badge" id="modalPayloadFormat">XML</span>
                    </div>
                </div>
            </div>

            <!-- Error Details -->
            <div>
                <div style="font-weight: 600; margin-bottom: 8px; color: var(--color-text);">
                    ‚ùå Original Error:
                </div>
                <div style="padding: 10px; background-color: var(--color-secondary);
                           border-radius: 4px; color: var(--color-text); font-size: 14px;">
                    <span id="modalErrorDetails">-</span>
                </div>
            </div>

            <!-- Payload Editor -->
            <div class="textarea-wrapper">
                <label class="textarea-label">üìÑ Payload (Edit to fix the error)</label>
                <textarea id="payloadEditor" placeholder="Paste your XML or JSON here..."></textarea>
                <div class="syntax-hint">
                    üí° Tip: Ensure valid XML or JSON syntax before submitting
                </div>
            </div>

            <!-- User Notes -->
            <div class="textarea-wrapper">
                <label class="textarea-label">üìù Notes (Optional)</label>
                <textarea id="userNotes" placeholder="What did you fix? e.g., 'Corrected customer ID format'"></textarea>
            </div>

            <!-- Action Buttons -->
            <div class="modal-actions">
                <button class="btn-cancel" onclick="closePayloadModal()">
                    ‚ùå Cancel
                </button>
                <button class="btn-submit" id="submitRetryBtn" onclick="submitRetryEvent()">
                    ‚úÖ Submit & Retry
                </button>
            </div>
        </div>
    </div>
</div>
<!-- ===== FOOTER ===== -->
<footer class="footer">
    <p>&copy; 2025 SAP Integration Dashboard | Powered by Spring Boot + Kafka + Thymeleaf</p>
</footer>

<!-- ===== JAVASCRIPT ===== -->
<script th:src="@{/js/dashboard.js}"></script>
<!-- Add this JavaScript before closing </body> tag -->
<script>
    // Global variables for modal
    let currentEventId = null;
    let currentPayloadFormat = 'JSON';

    /**
     * Open payload editor modal for failed event
     */
    function openPayloadModal(eventId) {
        currentEventId = eventId;

        // Fetch event details including payload
        fetch(`/api/events/${eventId}`)
            .then(response => response.json())
            .then(event => {
                // Populate modal with event details
                document.getElementById('modalOrderId').textContent = event.orderId;
                document.getElementById('modalRetryCount').textContent =
                    `${event.retryCount}/3`;
                document.getElementById('modalPayloadFormat').textContent =
                    event.payloadFormat || 'JSON';
                document.getElementById('modalErrorDetails').textContent =
                    event.errorDetails || 'No error details available';
                document.getElementById('payloadEditor').value =
                    event.payload || '{}';
                document.getElementById('userNotes').value = '';

                currentPayloadFormat = event.payloadFormat || 'JSON';

                // Check if can retry
                if (event.retryCount >= 3) {
                    document.getElementById('submitRetryBtn').disabled = true;
                    document.getElementById('submitRetryBtn').textContent =
                        '‚ùå Max Retries Reached';
                } else {
                    document.getElementById('submitRetryBtn').disabled = false;
                    document.getElementById('submitRetryBtn').textContent =
                        '‚úÖ Submit & Retry';
                }

                // Show modal
                document.getElementById('payloadModal').classList.add('show');
            })
            .catch(error => {
                console.error('Error fetching event details:', error);
                alert('Error loading event details');
            });
    }

    /**
     * Close payload editor modal
     */
    function closePayloadModal() {
        document.getElementById('payloadModal').classList.remove('show');
        currentEventId = null;
    }

    /**
     * Submit retry event with updated payload
     */
    function submitRetryEvent() {
        if (!currentEventId) {
            alert('Error: Event ID not found');
            return;
        }

        const updatedPayload = document.getElementById('payloadEditor').value;
        const userNotes = document.getElementById('userNotes').value;

        if (!updatedPayload || updatedPayload.trim() === '') {
            alert('Error: Payload cannot be empty');
            return;
        }

        // Disable button during submission
        const submitBtn = document.getElementById('submitRetryBtn');
        submitBtn.disabled = true;
        submitBtn.textContent = '‚è≥ Submitting...';

        // Create request
        const retryRequest = {
            eventId: currentEventId,
            updatedPayload: updatedPayload,
            payloadFormat: currentPayloadFormat,
            userNotes: userNotes
        };

        // Send to backend
        fetch(`/api/events/${currentEventId}/retry`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(retryRequest)
        })
        .then(response => {
            if (response.ok) {
                return response.json();
            } else {
                throw new Error('Failed to submit retry event');
            }
        })
        .then(data => {
            // Success!
            console.log('Retry event submitted successfully:', data);
            alert('‚úÖ Event sent to retry topic successfully!\n\n' +
                  'The event will be reprocessed by SAP Integration Suite.');

            closePayloadModal();

            // Refresh dashboard
            setTimeout(() => {
                location.reload();
            }, 1000);
        })
        .catch(error => {
            console.error('Error submitting retry event:', error);
            alert('‚ùå Error: ' + error.message);

            // Re-enable button
            submitBtn.disabled = false;
            submitBtn.textContent = '‚úÖ Submit & Retry';
        });
    }

    /**
     * Close modal when clicking outside
     */
    window.addEventListener('click', function(event) {
        const modal = document.getElementById('payloadModal');
        if (event.target === modal) {
            closePayloadModal();
        }
    });

    /**
     * Update retry button in table to open modal instead
     * Add this to your existing retry button code
     */
    function retryEvent(eventId) {
        openPayloadModal(eventId);
    }
</script>
<script>
    // Update current time every second
    function updateTime() {
        const now = new Date();
        document.getElementById('currentTime').innerText = now.toLocaleTimeString();
    }
    setInterval(updateTime, 1000);
    updateTime();

    // Create Chart.js doughnut chart
    const ctx = document.getElementById('statsChart').getContext('2d');
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Success', 'Failed', 'Pending'],
            datasets: [{
                // Get data from Thymeleaf variables
                data: [
                    [[${stats.successCount}]],
                    [[${stats.failedCount}]],
                    [[${stats.pendingCount}]]
                ],
                backgroundColor: ['#28a745', '#dc3545', '#ffc107']
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { position: 'bottom' }
            }
        }
    });

    // Dark mode toggle
    function toggleDarkMode() {
        document.body.classList.toggle('dark-mode');
        localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
    }

    // Load dark mode preference from browser storage
    if (localStorage.getItem('darkMode') === 'true') {
        document.body.classList.add('dark-mode');
    }
</script>

</body>
</html>
